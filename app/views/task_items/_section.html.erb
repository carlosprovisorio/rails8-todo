<% total = task.task_items.count %>
<% done  = task.task_items.where.not(completed_at: nil).count %>
<% pct   = total.zero? ? 0 : ((done.to_f / total) * 100).round %>

<div class="mt-3">
  <div class="d-flex justify-content-between align-items-center mb-1">
    <div class="small text-secondary">Subtasks</div>
    <div class="small text-secondary"><%= done %>/<%= total %> · <%= pct %>%</div>
  </div>
  <div class="progress mb-2" style="height: 6px;">
    <div class="progress-bar" role="progressbar" style="width: <%= pct %>%"></div>
  </div>

  <div class="vstack gap-1">
    <% task.task_items.each do |item| %>
      <div class="d-flex align-items-center gap-2">
        <%= button_to list_task_task_item_path(task.list, task, item, task_item: { }, completed: "toggle"),
              method: :patch, form: { data: { turbo_stream: true } },
              class: "btn btn-sm btn-outline-secondary" do %>
          <%= item.completed? ? "☑" : "☐" %>
        <% end %>
        <span class="<%= 'text-decoration-line-through text-secondary' if item.completed? %>"><%= item.title %></span>
        <%= button_to "✕", list_task_task_item_path(task.list, task, item),
              method: :delete, form: { data: { turbo_confirm: "Remove subtask?" } },
              class: "btn btn-sm btn-outline-danger ms-auto" %>
      </div>
    <% end %>
  </div>

  <%= form_with url: list_task_task_items_path(task.list, task), class: "d-flex gap-2 mt-2" do |f| %>
    <%= text_field_tag "task_item[title]", nil, class: "form-control", placeholder: "New subtask" %>
    <button class="btn btn-outline-primary btn-sm">Add</button>
  <% end %>
</div>
