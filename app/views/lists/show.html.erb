<div class="d-flex align-items-center justify-content-between mb-3">
  <div class="d-flex align-items-center gap-2">
    <span class="badge rounded-pill" style="background: <%= @list.color %>;">&nbsp;</span>
    <h1 class="h5 mb-0"><%= @list.name %></h1>
  </div>
  <%= link_to "All lists", lists_path, class: "btn btn-outline-secondary btn-sm" %>
</div>

<div class="d-flex align-items-center justify-content-between mb-2">
  <div class="d-flex flex-wrap gap-2">
    <% @saved_views.each do |v| %>
      <%= link_to v.name, list_path(@list, v.query), class: "btn btn-sm btn-outline-secondary" %>
      <%= button_to "✕",
      list_saved_view_path(@list, v),
      method: :delete,
      form: { data: { turbo_confirm: "Delete saved view '#{v.name}'?" } },
      class: "btn btn-sm btn-outline-danger" %>
    <% end %>
  </div>

  <%= form_with url: list_saved_views_path(@list), method: :post, class: "d-flex gap-2" do %>
    <input type="text" name="name" class="form-control form-control-sm" placeholder="Save current view as…" required />
    <%# Include current query params so controller can capture them %>
    <% [:q,:due,:priority,:status,:tag,:sort].each do |k| %>
      <%= hidden_field_tag k, params[k] if params[k].present? %>
    <% end %>
    <button class="btn btn-sm btn-primary">Save</button>
  <% end %>
</div>

<div class="card mb-3">
  <div class="card-body">
    <%= form_with url: list_path(@list), method: :get,
                  data: { controller: "debounce-submit", action: "input->debounce-submit#submit change->debounce-submit#submit",
                          turbo_frame: "tasks" },
                  class: "row g-2 align-items-end" do %>

      <div class="col-md-4">
        <label class="form-label">Search</label>
        <input type="search" name="q" value="<%= params[:q] %>" class="form-control" placeholder="Title, notes, tags">
      </div>

      <div class="col-md-2">
        <label class="form-label">Due</label>
        <select name="due" class="form-select">
          <%= options_for_select([["Any",""],["Overdue","overdue"],["Today","today"],["This week","week"],["No due date","none"]], params[:due]) %>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Priority</label>
        <select name="priority" class="form-select">
          <%= options_for_select([["Any",""]] + Task.priorities.keys.map{ |p| [p.titleize, p] }, params[:priority]) %>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
          <%= options_for_select([["Any",""]] + Task.statuses.keys.map{ |s| [s.titleize, s] }, params[:status]) %>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Tag</label>
        <input name="tag" value="<%= params[:tag] %>" class="form-control" list="tag-options">
        <datalist id="tag-options">
          <% @available_tags.each do |t| %>
            <option value="<%= t %>"></option>
          <% end %>
        </datalist>
      </div>


      <div class="col-md-2">
        <label class="form-label">Sort</label>
        <select name="sort" class="form-select">
          <%= options_for_select([["Manual","manual"],["Due ↑","due_asc"],["Due ↓","due_desc"],["Priority","priority"],["Created ↑","created_asc"],["Created ↓","created_desc"]], params[:sort] || "manual") %>
        </select>
      </div>

      <!-- Optional explicit submit for keyboard users -->
      <div class="col-auto">
        <button class="btn btn-outline-secondary">Apply</button>
      </div>
    <% end %>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <%= turbo_frame_tag "new_task" do %>
      <%= form_with model: @task,
            url: list_tasks_path(@list),
            data: { turbo_frame: "tasks", turbo_submits_with: "Adding…" },
            class: "row g-2 align-items-end" do |f| %>

        <div class="col-md-4">
          <%= f.label :title, class: "form-label" %>
          <%= f.text_field :title, class: "form-control", placeholder: "Task title", autofocus: true %>
        </div>
        <div class="col-md-3">
          <%= f.label :due_at, "Due", class: "form-label" %>
          <%= f.text_field :due_at, class: "form-control", data: { controller: "date-picker" } %>
        </div>
        <div class="col-md-2">
          <%= f.label :priority, class: "form-label" %>
          <%= f.select :priority, Task.priorities.keys.map { |p| [p.titleize, p] }, {}, class: "form-select" %>
        </div>
        <div class="col-md-3">
          <%= f.label :files, "Attach (optional)", class: "form-label" %>
          <%= f.file_field :files, multiple: true, direct_upload: true, class: "form-control" %>
        </div>
        <div class="col-12">
          <%= f.label :notes, class: "form-label" %>
          <%= f.text_area :notes, rows: 2, class: "form-control" %>
        </div>
        <div class="col-12">
          <%= f.label :tag_list, "Tags (comma-separated)", class: "form-label" %>
          <%= f.text_field :tag_list, class: "form-control", placeholder: "work, backend, urgent" %>
        </div>
        <div class="col-auto">
          <%= f.submit "Add Task", class: "btn btn-primary" %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>


<%= turbo_frame_tag "tasks" do %>
  <div class="list-group" data-controller="sortable" data-sortable-url-value="<%= reorder_list_tasks_path(@list) %>">
    <% @tasks.each do |task| %>
      <%= render "tasks/row", task: task %>
    <% end %>
  </div>
<% end %>
